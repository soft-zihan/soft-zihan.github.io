# 💾 I/O 性能与存储栈（从指标到证据）

> **常见真实场景**：
> “机器不怎么忙，但接口尾延迟很差；`iostat` 里 `await` 很高；删了大日志磁盘还是不回收；云盘偶发抖动你解释不清。”

本章目标是让你能把 I/O 问题说清楚：**是哪里慢、慢到什么程度、证据是什么**。不写通用排障流程，只讲“可验证的关键点”。

---

## 1. 先建立存储栈的心理模型

从应用角度看一次写入可能经过：

1. 应用写入（可能只是写到用户态缓冲）
2. 进入内核页缓存（page cache）
3. 脏页回写（writeback）/ `fsync` 强制落盘
4. 文件系统（ext4/xfs…）→ block layer → I/O scheduler
5. 设备（SSD/NVMe/云盘/RAID）或网络存储（NFS）

你要学会分清：慢的是 **应用等待** 还是 **设备响应**，以及是否被 **队列排队** 放大。

---

## 2. iostat：最常用的“设备层证据”

`iostat` 来自 `sysstat`：

```bash
sudo apt install sysstat
iostat -x -k 1
```

你需要重点关注的不是一个字段，而是“组合关系”：

* **%util**：设备忙碌程度（接近 100% 往往意味着队列在堆）
* **await**：平均 I/O 响应时间（包含排队时间）
* **r/s、w/s、rkB/s、wkB/s**：吞吐与 IOPS 的量级

一个非常常见的结论模式：
* `%util` 高 + `await` 高：队列在排（设备饱和或后端慢）
* `%util` 不高但 `await` 高：后端存储慢/抖动（云盘、阵列、网络存储），或某类同步写（fsync）把延迟抬高

---

## 3. 映射关系：你看到的 `sda` 到底是谁

I/O 指标必须能回答“这个设备对应哪个挂载点/业务数据”：

```bash
lsblk -o NAME,TYPE,SIZE,FSTYPE,MOUNTPOINT
df -hT
```

在云上尤其重要：你看到的是虚拟设备名，真实性能由后端存储决定，`%util` 的解释也可能与物理机不同。

---

## 4. 页缓存与回写：为什么 “free 很少” 但系统没问题

I/O 性能里最容易被忽略的是 page cache 与 writeback。

看一下脏页与回写量级：

```bash
grep -E 'Dirty|Writeback' /proc/meminfo
```

如果 `Dirty` 长期很高，说明有大量数据等着落盘；当写入突然集中、或后端存储慢，回写会放大尾延迟。

---

## 5. 同步写（fsync）与尾延迟：很多“抖动”都在这里

应用为了“写入可靠”会调用 `fsync/fdatasync`，它会把“等待落盘”的成本显式暴露给请求路径。

如果你怀疑某个进程被 fsync 拖慢，可以用 strace 抓证据（短时间观察即可）：

```bash
sudo strace -ttT -p <PID> -e trace=fsync,fdatasync
```

你要看的不是“有没有调用”，而是：
* 单次 `fsync` 是否耗时很长（例如几十毫秒到秒级）
* 是否频繁触发（写路径是否过于碎片化）

---

## 6. I/O 调度器：了解它，不要乱调它

看当前设备使用的调度器（不同内核/设备类型默认不同）：

```bash
cat /sys/block/<DEV>/queue/scheduler
```

你会看到类似 `mq-deadline`、`none` 等。进阶点在于：
* NVMe/高端 SSD 常见是 `none`（硬件队列更强，软件调度意义变小）
* 机械盘/部分云盘可能使用 `mq-deadline` 以改善延迟

调度器不是“越改越快”的旋钮，除非你能用基准测试证明收益，否则不要在生产上随手调整。

---

## 7. fio：把“感觉慢”变成“量化慢”（基准测试）

当你需要判断“后端存储到底能跑到什么水平”，fio 是最常用的基准工具。

```bash
sudo apt install fio
```

一个最小随机读测试（仅示例，务必在非生产数据盘或明确许可的目录上做）：

```bash
fio --name=randread --directory=/tmp --rw=randread --bs=4k --iodepth=16 --numjobs=1 --size=512M --runtime=20 --time_based --group_reporting
```

你要记录的是：
* IOPS/带宽
* 平均延迟与尾延迟（99%）

有了这些数字，你才能解释“这块盘的 SLO 能不能撑住你的业务”。

---

## 8. 常见误区（写得越具体越值钱）

1. **把 `await` 当成“设备响应时间”**：它包含排队时间，队列堆起来时 `await` 会被放大。
2. **只看 `df -h` 不看 “删文件不回收”**：文件被删除但仍被进程打开时空间不会回收，去看 `lsof +L1`。
3. **云盘把你教育了**：云盘 `await` 抖动并不罕见，证据链要能落到“同一时间窗口里 iostat 指标与业务延迟一起抬升”。这是解释问题最有说服力的方式。

