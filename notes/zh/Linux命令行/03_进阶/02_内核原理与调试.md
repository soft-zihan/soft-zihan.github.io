# 🧠 内核原理与深度调试

> **常见真实场景**：
> “会用 top 只是开始：Load Average 到底表示什么？进程为什么会变成 Zombie？系统慢的时候，如何把‘感觉’变成可验证的排查步骤？”

本章节将带你深入 Linux 内核的冰山之下，掌握“上帝视角”的排查能力。

## 1. 进程生命周期与状态

在 `top` 或 `ps` 中，你常看到 `S`, `R`, `D`, `Z` 等状态，它们对应了进程在内核中的不同阶段。

### 1.1 五大核心状态
1.  **R (Running/Runnable)**:
    *   **含义**：正在 CPU 上执行，或者**在运行队列中等待 CPU 调度**。
    *   **误区**：Load Average 高不一定是 CPU 忙，也可能是等待 CPU 的进程太多。
2.  **S (Interruptible Sleep)**:
    *   **含义**：**浅睡眠**。进程在等待事件（如等待 socket 数据、等待用户输入）。
    *   **特点**：可以被信号唤醒（如 `kill` 能杀掉）。绝大多数后台进程大部分时间都在这个状态。
3.  **D (Uninterruptible Sleep)**:
    *   **含义**：**深睡眠**（不可中断）。通常是在**等待磁盘 I/O**。
    *   **关键点**：此时进程**不响应任何信号**（包括 `kill -9`）。如果你看到大量 D 状态进程，常见原因是磁盘 I/O、网络文件系统（NFS）卡住、或内核在等待某些不可中断的内核路径完成。
4.  **Z (Zombie)**:
    *   **含义**：**僵尸进程**。进程已退出，但父进程还没来得及“收尸”（读取它的退出状态）。
    *   **危害**：不占内存，但**占用 PID 资源**。如果 PID 耗尽，系统就无法创建新进程。
    *   **处理**：无法直接 kill 僵尸（因为它已经死了）。真正的修复是让父进程执行 `wait()/waitpid()` 回收；在生产上更常见的做法是定位父进程并重启/修复它的回收逻辑（“kill 父进程”有业务风险，只能作为最后手段）。
5.  **T (Stopped)**:
    *   **含义**：进程被暂停（如收到 `SIGSTOP` 或 `Ctrl+Z`）。

### 1.2 Load Average 到底统计了什么
很多人以为 Load Average = CPU 使用率，其实不是。

* **它统计的是“系统中正在竞争资源的进程数量”**，典型包含：运行队列里的 `R`（可运行/正在运行）以及不可中断睡眠的 `D`（常见于 I/O 卡住）。
* `uptime` 的三个数字分别是 1/5/15 分钟的指数移动平均。

看原始数据：

```bash
cat /proc/loadavg
```

一个很实用的对照：

```bash
getconf _NPROCESSORS_ONLN
uptime
```

如果 Load 明显高于 CPU 核心数，但 `top` 里 CPU 并不满，往往意味着“不是算力不够，而是大量任务被卡在 I/O/不可中断路径上”。

---

## 2. 内存管理迷思

Linux 的内存管理策略是：**“闲置的内存是浪费”**。

### 2.1 内存去哪了？(Page Cache)
你运行 `free -h` 发现 `buff/cache` 占用很高，可用内存很少。
*   **真相**：Linux 会把读取过的文件缓存在内存中（Page Cache），下次读取直接走内存，速度快 N 倍。
*   **不用慌**：应用程序需要内存时，内核会瞬间释放 Cache 给应用用。

`free` 里更值得看的往往是 `available`（可用内存的估算值）而不是 `free`：

```bash
free -h
```

想看更底层的拆分：

```bash
grep -E 'MemTotal|MemFree|MemAvailable|Buffers|Cached|SwapTotal|SwapFree' /proc/meminfo
```

### 2.2 OOM Killer (内存溢出杀手)
当物理内存 + Swap 都耗尽时，内核会触发 **OOM Killer**。
*   **机制**：内核会对所有进程打分 (`oom_score`)，分数最高的（通常是占用内存最多且非核心的）会被直接杀掉以保全系统。
*   **排查**：查看日志 `dmesg | grep -i "out of memory"`。

你可以快速看某个进程“更可能被杀”的程度（分数越高越危险）：

```bash
cat /proc/<PID>/oom_score
cat /proc/<PID>/oom_score_adj
```

`oom_score_adj` 是“人为干预项”，系统服务/关键组件往往会把它调低，让自己更不容易被 OOM 杀掉。

### 2.3 Swap (交换空间)
*   **作用**：当物理内存不足时，把不活跃的内存数据搬到磁盘上。
*   **性能**：磁盘速度远慢于内存，如果系统频繁使用 Swap（Swap In/Out 很高），系统会巨卡。

---

## 3. 文件系统底层：Inode

### 3.1 什么是 Inode？
文件系统由两部分组成：
1.  **Block**：存文件的**实际内容**。
2.  **Inode**：存文件的**元数据**（权限、拥有者、时间、Block 的位置等）。

**面试题：为什么 `rm` 删除大文件很快？**
因为 `rm` 只是解除了文件名和 Inode 的链接，并标记 Inode 可用，并没有真正擦除 Block 里的数据（除非有其他硬链接）。

### 3.2 硬链接 vs 软链接
*   **硬链接 (Hard Link)**: `ln source target`
    *   **原理**：两个文件名指向**同一个 Inode**。
    *   **特点**：删除原文件，目标文件**依然可用**。不能跨分区，不能链接目录。
*   **软链接 (Symbolic Link)**: `ln -s source target` (类似 Windows 快捷方式)
    *   **原理**：创建一个新文件（有新 Inode），内容是原文件的**路径**。
    *   **特点**：删除原文件，软链接**失效**。可以跨分区，可以链接目录。

### 3.3 进阶必坑：文件删了为什么空间不回收
你可能遇到过：`df -h` 显示磁盘爆满，但你把“最大的日志文件”删掉了，空间却没回来。

原因通常是：**文件被删除后，仍然有进程持有它的文件描述符**，内核不会回收对应数据块，直到进程关闭该 fd。

查证据：

```bash
sudo lsof +L1 | head
```

`+L1` 会列出“link count < 1”的文件（已经没有目录项了，但仍被打开）。定位到进程后，再决定重启服务或让它重新打开日志。

---

## 4. 深度调试工具箱

### 4.1 strace：透视进程的“读心术”
当程序卡住、报错但没有日志时，`strace` 是神器。它能记录进程调用的所有**系统调用**。

*   **追踪进程**：`strace -p <PID>`
*   **统计耗时**：`strace -c -p <PID>` (查看进程把时间花在哪个系统调用上)
*   **更建议的“可用组合”**：
    * `strace -ttT -p <PID>`：带时间戳与耗时，适合判断“卡在哪个系统调用上”。
    * `strace -f -ttT -p <PID>`：跟踪子进程（很多服务会 fork/exec）。
    * `strace -e trace=file -p <PID>`：只看文件相关（open/openat/stat 等），比 `-e open` 更不容易漏。
*   **实战场景**：
    *   **Web服务起不来**：对启动命令做短追踪：`strace -f -ttT -o /tmp/nginx.strace /usr/local/nginx/sbin/nginx -t -c /usr/local/nginx/conf/nginx.conf`，再在输出里搜 `ENOENT` 找“打开失败的文件路径”。
    *   **程序卡死**：`strace -p PID` -> 发现一直停留在 `connect`，说明网络连不上。

### 4.2 vmstat：系统健康心电图
比 `top` 更客观的全局分析。
`vmstat 1` (每秒刷新一次)

```text
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 2  0      0 120000  40000 500000    0    0    10    20  100  200 10  5 85  0  0
```
*   **r (run)**: 运行队列长度。如果 `r > CPU核心数`，说明 CPU 负载重。
*   **b (block)**: 等待 I/O 的进程数（即 D 状态）。如果不为 0，说明磁盘可能是瓶颈。
*   **si/so**: Swap In/Out。**如果不为 0，说明内存严重不足**，系统正在颠簸。
*   **wa (wait)**: CPU 等待 I/O 的时间百分比。如果很高，确认磁盘瓶颈。

### 4.3 iostat：磁盘性能分析
`iostat` 来自 `sysstat` 包（很多最小化系统默认没装）：

```bash
sudo apt install sysstat
iostat -x -k 1
```

*   **%util**: 磁盘利用率。如果接近 100%，说明磁盘已经饱和（满负荷运转），请求在排队。
*   **await**: 平均 I/O 响应时间（包含排队时间）。如果这个值很大（例如机械盘持续 > 50ms、SSD 持续 > 10ms），通常意味着 I/O 压力或后端存储抖动。

读 iostat 的一个小技巧：不要只盯一个指标，把它们一起看：
* `%util` 高 + `await` 高：设备忙到排队（或后端慢）。
* `%util` 不高但 `await` 高：可能是云盘/阵列后端慢，或单次 I/O 体积/同步写导致延迟大。
