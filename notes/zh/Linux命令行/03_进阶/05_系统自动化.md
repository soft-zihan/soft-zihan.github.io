# 🤖 系统自动化与服务 (Automation & Services)

让 Linux 自动为你工作：管理后台服务 (`systemd`) 和配置定时任务 (`cron`)。

## 1. systemctl - 服务管理 (Systemd)

在现代 Linux (如 Ubuntu 18.04+, CentOS 7+) 中，`systemd` 是管理服务的标准工具。

### 核心命令
- **`sudo systemctl status nginx`**：**查看状态** (排查故障第一步)。
- **`sudo systemctl start nginx`**：启动服务。
- **`sudo systemctl stop nginx`**：停止服务。
- **`sudo systemctl restart nginx`**：重启服务。
- **`sudo systemctl reload nginx`**：**重载配置** (不中断服务，仅重新读取配置文件)。

### 开机自启
- **`sudo systemctl enable nginx`**：设置开机自启。
- **`sudo systemctl disable nginx`**：禁用开机自启。

### 💡 优雅地修改配置
- **传统做法**：直接改 `/lib/systemd/system/xxx.service`。*缺点*：软件更新后会被覆盖。
- **优雅做法**：`sudo systemctl edit nginx`。
  - 它会创建一个“补丁”文件（Drop-in file）。
  - 你只需写入要覆盖的部分（如 `ExecStart=`），系统会自动合并。
  - 运行 `sudo systemctl daemon-reload` 即可生效。

---

## 2. journalctl - 系统日志管家

`systemd` 统一管理了所有服务的日志，`journalctl` 是唯一的查询入口。

### 实时追踪
- **`journalctl -f`**：类似 `tail -f`，查看最新产生的日志。
- **`journalctl -u nginx.service -f`**：**实时追踪特定服务**。

### 错误排查
- **`journalctl -b`**：只看**本次启动后**的日志。
- **`journalctl -p err -b`**：只查看**错误 (Error) 级别**以上的日志。
- **`journalctl -xe`**：查看最后几行并附带错误解释 (排查服务启动失败神器)。

### 💡 空间清理
- `journalctl --disk-usage`：查看占用空间。
- `sudo journalctl --vacuum-time=7d`：删除 7 天前的旧日志。

---

## 3. Crontab - 定时任务 (自动化核心)

Linux 的“闹钟”，让系统在指定时间自动运行脚本。

### 核心命令
- **`crontab -e`**：编辑当前用户的定时任务。
- **`crontab -l`**：列出当前所有任务。

### 语法逻辑 (5 个星号)
`* * * * * command`
(分 时 日 月 周)

| 示例 | 含义 |
| :--- | :--- |
| `0 2 * * *` | 每天凌晨 2:00 执行 |
| `*/15 * * * *` | 每 15 分钟执行一次 |
| `0 9-18 * * *` | 每天 9点到18点整点执行 |
| `0 0 1 * *` | 每月 1号凌晨 0:00 执行 |

### 💡 避坑指南
1. **路径问题**：Crontab 环境**没有**你的 PATH 变量。
   - **错误**：`python script.py`
   - **正确**：`/usr/bin/python3 /home/han/script.py` (使用绝对路径)
   - **或者**：在 crontab 文件第一行手动定义 PATH：`PATH=/usr/local/bin:/usr/bin:/bin`
2. **日志重定向**：默认情况下 crontab 报错你看不见。
   - **建议**：`* * * * * /cmd >> /tmp/cron.log 2>&1`

### systemd timer：更“现代”的定时任务
如果你的系统是 systemd（大多数发行版都是），`timer` 往往比 cron 更适合生产环境：
- **更好排障**：日志直接进 `journalctl`，不用自己重定向。
- **更可控**：可以声明依赖（网络/磁盘就绪后再跑）。
- **更可靠**：支持错过补跑（如机器重启后补执行）。

想把自己的程序做成标准服务并配套定时器？可参考：[系统构建与部署实战](../05_高级/01_系统构建与部署.md) 里的 systemd 单元文件示例。

---

## 4. 硬件与系统信息
当别人问你“这服务器什么配置”时，用这几招：
- **CPU**: `lscpu` (核心数、架构、主频)。
- **内存**: `free -h` (关注 **Available** 而不是 Free)。
- **磁盘**: `df -h` / `lsblk`。
- **设备**: `lsusb` / `lspci`。
- **内核日志**: `dmesg -T` (查看硬件故障)。
