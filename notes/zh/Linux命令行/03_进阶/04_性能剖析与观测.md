# 🔬 性能剖析与观测（Perf / PSI）

> **常见真实场景**：
> “CPU 看起来不高但延迟很大；或者 CPU 很高但 `top` 看不出在忙什么。你需要的不是‘多开机器’，而是能拿到**证据**：时间到底花在哪？”

本章不讲通用排障套路，只讲进阶观测中最能提升“含金量”的三件事：**CPU 采样剖析（perf）**、**调度/等待视角（off-CPU）**、**资源压力指标（PSI）**。

---

## 1. 先把问题“定类”：你要测的是哪一种慢

常见性能问题大致分四类（分类错了，工具再强也会误用）：

1. **on-CPU 慢**：CPU 真在做事（算法/热点函数/加密压缩/GC）。
2. **off-CPU 慢**：CPU 不忙，但线程在等（锁竞争、I/O、调度、缺页）。
3. **内存压力**：频繁回收/换页，表现为抖动或尾延迟飙升。
4. **I/O 压力**：磁盘/网络存储慢，排队导致 `await` 高。

最小化“定类”组合（不做排障，只做定位方向）：

```bash
uptime
vmstat 1
ss -s
```

看到 `vmstat` 的 `r` 长期高于 CPU 核心数，倾向 on-CPU；看到 `wa` 高或大量 D 状态，倾向 I/O；看到 `si/so` 或 `pswpin/pswpout` 有值，倾向内存压力。

---

## 2. perf：用采样回答“CPU 时间花在哪”

### 2.1 安装与权限前置

很多系统默认没有 `perf`：

```bash
perf --version
```

Ubuntu/Debian 常见安装方式（内核版本要匹配）：

```bash
sudo apt install linux-tools-common linux-tools-$(uname -r)
```

如果你遇到权限/采样受限，常见是内核参数限制了 perf 事件（例如 `kernel.perf_event_paranoid`）。这不是“命令不会用”，而是“系统策略不允许”。

### 2.2 perf stat：先量化“是不是 CPU 指令效率问题”

对单个进程采样统计 10 秒：

```bash
sudo perf stat -p <PID> -- sleep 10
```

你会看到诸如 `cycles`、`instructions`、`context-switches`、`cpu-migrations`、`page-faults` 等。

一个非常好用的直觉指标是 **IPC（instructions per cycle）**：
* IPC 很低 + cache miss/分支失误高：可能是内存访问模式差、分支预测差、或大量 syscall。
* IPC 正常但耗时高：更像纯计算热点。

### 2.3 perf top：实时看“热点符号”在跳

```bash
sudo perf top -p <PID>
```

你看到的函数名/符号就是“CPU 正在烧在哪”。如果全是 `ksoftirqd`、`__netif_receive_skb_core` 这类内核符号，问题可能在网络包处理；如果是 `do_sys_openat2`、`vfs_read` 之类，可能是文件 I/O 或 syscalls 频繁。

### 2.4 perf record/report：拿到可复现证据（含调用栈）

对进程采样 30 秒（99Hz），带调用栈：

```bash
sudo perf record -F 99 -p <PID> -g -- sleep 30
sudo perf report
```

读 `perf report` 的重点不是“哪个函数占比最高”，而是：
* 热点是否稳定（是否每次都指向同一条路径）
* 热点是用户态还是内核态
* 调用栈上游是否指向某个业务入口/线程池/锁

如果你需要导出文本证据便于分享：

```bash
sudo perf report --stdio | head -n 80
```

---

## 3. off-CPU：CPU 不忙但还是慢，通常慢在“等”

很多“尾延迟”问题不是算力不够，而是等待变多：锁竞争、I/O 排队、调度抢占、缺页。

一个常用抓手是先验证“进程状态分布”：

```bash
ps -eo state,pid,comm,wchan:32 --sort=state | head
```

`wchan` 会给你“线程在内核里等什么”的线索（例如等 futex、等 IO、等网络）。

当你需要更强的调度证据时，可以用 perf 的调度观察能力（会更重一些）：

```bash
sudo perf sched timehist --pid <PID> -- sleep 10
```

你要看的不是某个参数，而是：线程是否频繁被换出、是否存在长时间不可运行区间。

---

## 4. PSI：把“压力”量化成可观测指标（非常适合容器/云上）

PSI（Pressure Stall Information）回答的问题是：
> “系统里有多少任务因为资源不足而被迫等待？等待发生了多久？”

三类压力：CPU / memory / IO。

```bash
cat /proc/pressure/cpu
cat /proc/pressure/memory
cat /proc/pressure/io
```

输出里常见两行：
* `some`：部分任务被迫等待
* `full`：所有非 idle 任务都在等（更严重）

当你看到 `avg10/avg60/avg300` 持续上升时，它往往比“CPU 使用率”更能解释尾延迟抖动。

---

## 5. 常见误区（进阶里最容易翻车的点）

1. **把 perf 当成“万能排障工具”**：perf 解决的是“时间花在哪”，不是直接给你根因答案。
2. **看到内核符号就慌**：内核占比高不代表“内核有 bug”，可能只是你的 workload 在触发大量 syscalls/网络包。
3. **忽略采样窗口**：采样 3 秒与采样 60 秒得到的结论可能完全不同，尤其是抖动型问题。

