# ğŸ—ï¸ ç³»ç»Ÿæ„å»ºä¸éƒ¨ç½²å®æˆ˜

> **å¸¸è§çœŸå®éœ€æ±‚**ï¼š
> â€œä¼šç”¨ `apt install nginx` åªæ˜¯å¼€å§‹ã€‚å¦‚æœéœ€è¦å®šåˆ¶æ¨¡å—ã€æ’æŸ¥å¯åŠ¨å¤±è´¥ã€åšæˆå¯ç»´æŠ¤çš„æœåŠ¡ï¼Œä½ éœ€è¦æ‡‚ `make`ã€å®‰è£…å¸ƒå±€ä¸ `systemd`ã€‚â€

æœ¬ç« èŠ‚å¸¦ä½ ä»æºç ç¼–è¯‘å¼€å§‹ï¼Œæ‰‹åŠ¨æ­å»ºä¸€ä¸ªç”Ÿäº§çº§ Web æœåŠ¡ç¯å¢ƒã€‚

## 1. ä»æºç ç¼–è¯‘å®‰è£… Nginx

è™½ç„¶åŒ…ç®¡ç†å™¨ï¼ˆapt/yumï¼‰å¾ˆæ–¹ä¾¿ï¼Œä½†æºç ç¼–è¯‘èƒ½è®©ä½ ï¼š
1.  ä½¿ç”¨å®˜æ–¹æºä¸­æ²¡æœ‰çš„æœ€æ–°ç‰ˆæœ¬ã€‚
2.  **å®šåˆ¶åŒ–**ï¼šæ·»åŠ ç¬¬ä¸‰æ–¹æ¨¡å—ï¼ˆå¦‚ `lua-nginx-module`ï¼‰æˆ–è£å‰ªä¸ç”¨çš„åŠŸèƒ½ã€‚
3.  æ·±å…¥ç†è§£è½¯ä»¶çš„å®‰è£…è·¯å¾„å’Œä¾èµ–å…³ç³»ã€‚

### 1.1 å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ
åœ¨ Ubuntu/Debian ä¸Šï¼Œä½ éœ€è¦å®‰è£…ç¼–è¯‘å™¨å’Œæ ¸å¿ƒä¾èµ–åº“ï¼š

```bash
sudo apt update
sudo apt install build-essential zlib1g zlib1g-dev libssl-dev libpcre2-dev ca-certificates
```
*   `build-essential`: åŒ…å« gcc, make ç­‰åŸºç¡€å·¥å…·ã€‚
*   `libpcre2-dev`: Nginx çš„ Rewrite/æ­£åˆ™ç›¸å…³èƒ½åŠ›ä¾èµ–ï¼ˆéƒ¨åˆ†ç³»ç»ŸåŒ…å/ç‰ˆæœ¬å¯èƒ½ä¸åŒï¼‰ã€‚
*   `zlib1g`: Gzip å‹ç¼©æ¨¡å—éœ€è¦ã€‚
*   `libssl`: HTTPS/SSL æ¨¡å—éœ€è¦ã€‚
*   `ca-certificates`: ç”¨äº HTTPS ä¸‹è½½æ—¶çš„è¯ä¹¦é“¾ï¼ˆé¿å… curl/wget æŠ¥è¯ä¹¦é—®é¢˜ï¼‰ã€‚

### 1.2 ä¸‹è½½ä¸è§£å‹
å» [Nginx å®˜ç½‘](https://nginx.org/en/download.html) æ‰¾æœ€æ–° Stable ç‰ˆæœ¬ã€‚

```bash
wget https://nginx.org/download/nginx-1.24.0.tar.gz
tar -zxvf nginx-1.24.0.tar.gz
cd nginx-1.24.0
```

### 1.3 æ ¡éªŒä¸‹è½½åŒ…ï¼ˆé¿å…â€œä¸‹åˆ°è¢«æ›¿æ¢çš„ tar.gzâ€ï¼‰
ç”Ÿäº§ç¯å¢ƒå»ºè®®è‡³å°‘åšä¸€æ¬¡ sha256 æ ¡éªŒï¼š

```bash
sha256sum nginx-1.24.0.tar.gz
```

å»å®˜ç½‘æŠŠå¯¹åº”ç‰ˆæœ¬çš„æ ¡éªŒå€¼å¯¹ä¸Šï¼ˆæ ¡éªŒå€¼ä¸ä¸€è‡´å°±ä¸è¦ç»§ç»­è§£å‹/ç¼–è¯‘ï¼‰ã€‚

### 1.4 Configure (é…ç½®)
è¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼Œå†³å®šäº†å®‰è£…è·¯å¾„å’Œå¯ç”¨çš„æ¨¡å—ã€‚

```bash
./configure \
    --prefix=/usr/local/nginx \
    --sbin-path=/usr/local/nginx/sbin/nginx \
    --conf-path=/usr/local/nginx/conf/nginx.conf \
    --pid-path=/usr/local/nginx/logs/nginx.pid \
    --error-log-path=/usr/local/nginx/logs/error.log \
    --http-log-path=/usr/local/nginx/logs/access.log \
    --with-http_ssl_module \
    --with-http_v2_module \
    --with-http_gzip_static_module
```
*   `--prefix`: æŒ‡å®šå®‰è£…ç›®å½•ï¼ˆæ¨è `/usr/local/nginx`ï¼Œæ–¹ä¾¿ç»Ÿä¸€ç®¡ç†ï¼‰ã€‚
*   `--with-...`: æ˜¾å¼å¯ç”¨æŸäº›é»˜è®¤ä¸å¼€å¯çš„æ¨¡å—ï¼ˆå¦‚ SSL, HTTP/2ï¼‰ã€‚
*   `--*-path`: æ˜ç¡®å…³é”®æ–‡ä»¶ä½ç½®ï¼Œé¿å…â€œè£…å®Œä¸çŸ¥é“é…ç½®/æ—¥å¿—/PID åœ¨å“ªâ€ã€‚

å¦‚æœä½ åç»­è¦å¼•å…¥ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œä¸€èˆ¬ä¼šç”¨åˆ°ï¼š
* `--add-module=/path/to/module`ï¼ˆé™æ€ç¼–è¿›äºŒè¿›åˆ¶ï¼‰
* `--add-dynamic-module=/path/to/module`ï¼ˆç¼–æˆåŠ¨æ€æ¨¡å—ï¼Œå‡çº§æ›´çµæ´»ï¼‰

**æ£€æŸ¥è¾“å‡º**ï¼šå¦‚æœæŠ¥é”™ "Library not found"ï¼Œè¯´æ˜ç¼ºå°‘å¯¹åº”çš„ `-dev` åº“ï¼Œéœ€å›å¤´å®‰è£…ã€‚

### 1.5 Make & Install (ç¼–è¯‘ä¸å®‰è£…)

```bash
make -j4          # ä½¿ç”¨ 4 æ ¸ CPU å¹¶è¡Œç¼–è¯‘
sudo make install # å°†ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶åˆ° --prefix ç›®å½•
```

æ­¤æ—¶ï¼ŒNginx å°±å®‰è£…åœ¨ `/usr/local/nginx` ä¸‹äº†ã€‚
éªŒè¯ï¼š`/usr/local/nginx/sbin/nginx -V`

å»ºè®®é¡ºæ‰‹æŠŠ `nginx -V` è¾“å‡ºä¿å­˜ä¸‹æ¥ï¼ˆé‡Œé¢åŒ…å« configure argumentsï¼‰ï¼Œä»¥åå‡çº§/é‡ç¼–è¯‘èƒ½å¤ç°åŒä¸€å¥—ç¼–è¯‘é€‰é¡¹ã€‚
---

## 2. é©¯æœ Systemdï¼šå°†ç¨‹åºå˜æˆæœåŠ¡

æ‰‹åŠ¨è¿è¡Œ `/usr/local/nginx/sbin/nginx` å¾ˆéº»çƒ¦ï¼Œè€Œä¸”å¼€æœºä¸ä¼šè‡ªå¯ã€‚æˆ‘ä»¬éœ€è¦æŠŠå®ƒäº¤ç»™ Linux çš„ç®¡å®¶ â€”â€” **Systemd**ã€‚

åˆ›å»ºä¸€ä¸ª Unit æ–‡ä»¶ï¼š
`sudo vim /etc/systemd/system/nginx.service`

```ini
[Unit]
Description=The Nginx HTTP and reverse proxy server
After=network.target remote-fs.target nss-lookup.target

[Service]
Type=forking
PIDFile=/usr/local/nginx/logs/nginx.pid
# Nginx å¯åŠ¨å‘½ä»¤ (ç»å¯¹è·¯å¾„)
ExecStartPre=/usr/local/nginx/sbin/nginx -t -c /usr/local/nginx/conf/nginx.conf
ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf
ExecReload=/usr/local/nginx/sbin/nginx -s reload -c /usr/local/nginx/conf/nginx.conf
ExecStop=/usr/local/nginx/sbin/nginx -s quit -c /usr/local/nginx/conf/nginx.conf
Restart=on-failure
RestartSec=2
LimitNOFILE=65535
PrivateTmp=true

[Install]
WantedBy=multi-user.target
```

**å…³é”®ç‚¹è§£æ**ï¼š
*   `[Unit]`: æè¿°æœåŠ¡ä¾èµ–ï¼ˆåœ¨ç½‘ç»œå¯åŠ¨åå†å¯åŠ¨ï¼‰ã€‚
*   `[Service]`:
    *   `Type=forking`: Nginx å¯åŠ¨åä¼š fork å‡º worker è¿›ç¨‹ï¼Œä¸»è¿›ç¨‹é€€å‡ºï¼Œè¿™æ˜¯æ ‡å‡†çš„åå°å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼ã€‚
    *   `ExecStart`: å¯åŠ¨å‘½ä»¤ã€‚
    *   `ExecReload`: é‡è½½é…ç½®å‘½ä»¤ (`systemctl reload nginx` ä¼šæ‰§è¡Œè¿™ä¸ª)ã€‚
    *   `LimitNOFILE`: æå‡æ–‡ä»¶æè¿°ç¬¦ä¸Šé™ï¼Œé¿å…é«˜å¹¶å‘ä¸‹å‡ºç° â€œtoo many open filesâ€ã€‚
*   `[Install]`: `multi-user.target` ç›¸å½“äºä»¥å‰çš„ Runlevel 3ï¼ˆå¤šç”¨æˆ·å‘½ä»¤è¡Œæ¨¡å¼ï¼‰ï¼ŒæŒ‡å®šæœåŠ¡åœ¨ä»€ä¹ˆè¿è¡Œçº§åˆ«ä¸‹è‡ªå¯ã€‚

**å¯ç”¨æœåŠ¡**ï¼š
```bash
sudo systemctl daemon-reload    # è®© systemd é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶
sudo systemctl start nginx      # å¯åŠ¨
sudo systemctl enable nginx     # å¼€æœºè‡ªå¯
sudo systemctl status nginx     # æŸ¥çœ‹çŠ¶æ€
```

å¿«é€ŸéªŒè¯ä¸¤ä»¶äº‹ï¼š
* é…ç½®æ˜¯å¦æ­£ç¡®ï¼š`/usr/local/nginx/sbin/nginx -t -c /usr/local/nginx/conf/nginx.conf`
* ç«¯å£æ˜¯å¦åœ¨ç›‘å¬ï¼š`ss -lntp | grep -E ':80|:443'`

---

## 3. éƒ¨ç½² Web åç«¯ä¸åå‘ä»£ç†

**åœºæ™¯**ï¼šä½ å†™äº†ä¸€ä¸ª Python (Flask) æˆ– Go çš„åç«¯æœåŠ¡ï¼Œè¿è¡Œåœ¨ 8000 ç«¯å£ã€‚ä½ éœ€è¦é€šè¿‡ Nginx æŠŠ 80 ç«¯å£çš„æµé‡è½¬å‘ç»™å®ƒã€‚

### 3.1 å¯åŠ¨åç«¯ (ç¤ºä¾‹)
å‡è®¾æœ‰ä¸€ä¸ª `app.py`ï¼š
```python
from flask import Flask
app = Flask(__name__)

@app.route('/')
def hello():
    return "Hello from Backend!"

if __name__ == '__main__':
    app.run(port=8000)
```
åå°è¿è¡Œï¼š`nohup python3 app.py &`

### 3.2 é…ç½® Nginx åå‘ä»£ç†
ç¼–è¾‘ `/usr/local/nginx/conf/nginx.conf`ï¼š

```nginx
server {
    listen       80;
    server_name  your_domain.com;  # æˆ–è€…æ˜¯ IP åœ°å€

    location / {
        proxy_pass http://127.0.0.1:8000; # è½¬å‘ç»™åç«¯
        
        # ä¼ é€’å®¢æˆ·ç«¯çœŸå® IP (é¢è¯•å¸¸è€ƒç‚¹)
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # å¸¸è§â€œè·‘èµ·æ¥äº†ä½†å¾ˆåˆ«æ‰­â€çš„ç»†èŠ‚ï¼šé•¿è¿æ¥ä¸è¶…æ—¶
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_read_timeout 60s;
    }
}
```
**ä¸ºä»€ä¹ˆè¦è®¾ç½® Headerï¼Ÿ**
åç«¯åº”ç”¨æ‹¿åˆ°çš„è¯·æ±‚æ˜¯ Nginx å‘èµ·çš„ï¼Œæ‰€ä»¥ `Remote_Addr` é»˜è®¤æ˜¯ `127.0.0.1`ã€‚å¿…é¡»é€šè¿‡ `X-Real-IP` å‘Šè¯‰åç«¯çœŸå®çš„å®¢æˆ·ç«¯æ˜¯è°ã€‚

é‡è½½é…ç½®ï¼š`sudo systemctl reload nginx`

---

## 4. HTTPSï¼šé…ç½® SSL è¯ä¹¦ (Certbot)

æ²¡æœ‰ HTTPS çš„ç½‘ç«™æ˜¯ä¸åˆæ ¼çš„ã€‚æˆ‘ä»¬ä½¿ç”¨ **Let's Encrypt** å…è´¹è¯ä¹¦ã€‚

### 4.1 å®‰è£… Certbot
ä¸åŒå‘è¡Œç‰ˆçš„ certbot å®‰è£…æ–¹å¼å·®å¼‚å¾ˆå¤§ï¼š

* Debian/Ubuntuï¼šé€šå¸¸å¯ä»¥å…ˆè¯• `apt`ï¼ˆç‰ˆæœ¬å¯èƒ½åæ—§ï¼‰
* Ubuntu æ–°ç‰ˆæœ¬ï¼šæ›´å¸¸è§çš„æ˜¯ `snap`ï¼ˆç‰ˆæœ¬æ›´æ–°ã€æ›´â€œå®˜æ–¹â€ï¼‰

```bash
sudo apt install certbot
```

### 4.2 ç”³è¯·è¯ä¹¦ (Webroot æ¨¡å¼)
Certbot éœ€è¦éªŒè¯ä½ æ‹¥æœ‰è¿™ä¸ªåŸŸåã€‚å®ƒä¼šåœ¨ä½ çš„ç½‘ç«™æ ¹ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œç„¶åé€šè¿‡ HTTP è®¿é—®æ¥éªŒè¯ã€‚

```bash
# å‡è®¾ä½ çš„ç½‘ç«™æ ¹ç›®å½•åœ¨ /usr/local/nginx/html
sudo certbot certonly --webroot -w /usr/local/nginx/html -d your_domain.com
```

### 4.3 é…ç½® Nginx ä½¿ç”¨è¯ä¹¦
ä¿®æ”¹ `nginx.conf`ï¼š

```nginx
server {
    listen 443 ssl http2;
    server_name your_domain.com;

    ssl_certificate /etc/letsencrypt/live/your_domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your_domain.com/privkey.pem;

    # æ¨èçš„å®‰å…¨å‚æ•°
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    location / {
        proxy_pass http://127.0.0.1:8000;
        # ... header é…ç½® ...
    }
}

# å¼ºåˆ¶è·³è½¬ HTTPS
server {
    listen 80;
    server_name your_domain.com;
    return 301 https://$host$request_uri;
}
```

### 4.4 è‡ªåŠ¨ç»­æœŸ
Let's Encrypt è¯ä¹¦åªæœ‰ 90 å¤©æœ‰æ•ˆæœŸã€‚
æµ‹è¯•è‡ªåŠ¨ç»­æœŸå‘½ä»¤ï¼š`sudo certbot renew --dry-run`
åœ¨ä¸å°‘ç³»ç»Ÿä¸Šï¼Œcertbot ä¼šè‡ªå¸¦ systemd timerï¼›å»ºè®®ä¼˜å…ˆç”¨å®ƒè€Œä¸æ˜¯æ‰‹å†™ cronï¼ˆæ›´å¯è§‚æµ‹ã€ä¹Ÿæ›´å®¹æ˜“æ’æŸ¥å¤±è´¥åŸå› ï¼‰ã€‚
åœ¨ä¸å°‘ç³»ç»Ÿä¸Šï¼Œcertbot ä¼šè‡ªå¸¦ systemd timerï¼›å»ºè®®ä¼˜å…ˆç”¨å®ƒè€Œä¸æ˜¯æ‰‹å†™ cronï¼ˆæ›´å¯è§‚æµ‹ã€ä¹Ÿæ›´å®¹æ˜“æ’æŸ¥å¤±è´¥åŸå› ï¼‰ã€‚

---

## æ€»ç»“
é€šè¿‡è¿™ä¸€å¥—æµç¨‹ï¼Œä½ å±•ç¤ºäº†ï¼š
1.  **Linux åŸºç¡€**ï¼šè§£å‹ã€æ–‡ä»¶æ“ä½œã€‚
2.  **æ„å»ºèƒ½åŠ›**ï¼šMake ç¼–è¯‘ã€‚
3.  **ç³»ç»Ÿç®¡ç†**ï¼šSystemd æœåŠ¡ç¼–å†™ã€‚
4.  **Web æ¶æ„**ï¼šåå‘ä»£ç†ã€Header ä¼ é€’ã€SSL é…ç½®ã€‚
è¿™äº›æ˜¯â€œè„šæœ¬å°å­â€å’Œâ€œç³»ç»Ÿå·¥ç¨‹å¸ˆâ€çš„åˆ†æ°´å²­ã€‚
